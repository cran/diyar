<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="date" content="2019-11-10" />

<title>Multistage deterministic linkage in R</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">Multistage deterministic linkage in R</h1>
<h4 class="date">10 November 2019</h4>



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>Linking multiple datasets to consolidate information is a common task in research, particularly in those involving the use of “big data”. Deterministic record linkage is the simplest and most common method for record linkage however, its accuracy relies on data quality. Too many incorrect or missing values will often provide an unacceptable number of false matches or mismatches.</p>
<p>This function aims to provide a simple, multistage and flexible implementation of deterministic record linkage that tries to improve the linkage of datasets containing missing or incorrect group identifiers e.g. customer, patient or admission codes. In such instances, alternative identifiers like dates, names, height or other attributes are used in a specified order of preference.</p>
</div>
<div id="uses" class="section level1">
<h1>Uses</h1>
<p>Arguments in <code>record_group()</code> control separate aspects of the linkage process. Different combinations of each argument can be used to link datasets in a variety of ways. Examples of these include;</p>
<ul>
<li>Linking datasets on one (or more) matching <code>criteria</code></li>
<li>Linking datasets on one (or more) matching <code>criteria</code> and one (or more) matching <code>sub_criteria</code>. See <a href="#record_matching">record matching</a></li>
<li>Linking datasets in stages. Each stage is considered more certain than the subsequent one. See <a href="#record_expansion">record group expansion</a></li>
<li>Linking datasets with missing group identifiers. See <a href="#missing_values">handling missing values</a></li>
</ul>
</div>
<div id="implementation" class="section level1">
<h1>Implementation</h1>
<p>Record linkage is done in stages. Each stage is considered more relevant than the subsequent one i.e. a match at stage 1 is taken to be more relevant than one at stage 2.</p>
<p>Records are assigned a unique group ID if they match on a <code>criteria</code>. The group ID is essentially the record ID (<code>sn</code>) of one of the matching records. Therefore, if you use a familiar record ID (<code>sn</code>), you can link the results back to the original dataset.</p>
<p>The <code>criteria</code> should be provided as column names of the attributes to be compared. This argument takes advantage of <code>dplyr</code> quasiquotation.</p>
<p>One or more <code>sub_criteria</code> can be used at each stage to include additional conditions for a match. This is provided as a <code>list</code> of named <code>vectors</code>. Each named vector contains column names. When a <code>sub_criteria</code> is used, records will only be assigned a group ID when they match on the <code>criteria</code>, and at least one named column in each <code>sub_criteria</code>.</p>
<p>Each <code>sub_criteria</code> should be paired with a corresponding <code>criteria</code>. To do this, the vector name for each <code>sub_criteria</code> should be prefixed with <code>&quot;s&quot;</code> and the corresponding <code>criteria</code> number e.g. <code>&quot;s1&quot;</code> or <code>&quot;s4&quot;</code>. When a <code>criteria</code> is paired to more than one <code>sub_criteria</code>, include a suffix after the <code>criteria</code> number e.g. <code>&quot;s1a&quot;</code>, <code>&quot;s1b&quot;</code> and <code>&quot;s1c&quot;</code>. <a href="#sub_cri_example">See examples</a>. Any <code>sub_criteria</code> not paired to a <code>criteria</code> will be ignored. The <code>sub_criteria</code> argument does not support quasiquotation.</p>
<p>At each stage, the function prints the number of records that have been assigned a group ID and how many groups have only one record.</p>
<p><strong><em>NOTE; <code>to_s4</code> and <code>to_s4()</code> changes the function’s output from a data.frame (current default) to <code>pid</code> objects. <code>pid</code> objects will be the default output in the next release.</em></strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(diyar); <span class="kw">library</span>(dplyr)
<span class="kw">data</span>(patient_list); 
dbs &lt;-<span class="st"> </span>patient_list[<span class="kw">c</span>(<span class="st">&quot;forename&quot;</span>,<span class="st">&quot;surname&quot;</span>,<span class="st">&quot;sex&quot;</span>)]; dbs
<span class="co">#&gt; # A tibble: 6 x 3</span>
<span class="co">#&gt;   forename surname sex  </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;</span>
<span class="co">#&gt; 1 James    Green   M    </span>
<span class="co">#&gt; 2 ESTHER   Kulmar  F    </span>
<span class="co">#&gt; 3 &quot;&quot;       OBI     F    </span>
<span class="co">#&gt; 4 Jamey    Green   M    </span>
<span class="co">#&gt; 5 Daniel   Kulmar  M    </span>
<span class="co">#&gt; 6 Henry    OBI     M</span>

<span class="co"># 1 stage &lt;- Matching surname only</span>
dbs<span class="op">$</span>pids_a &lt;-<span class="kw">record_group</span>(dbs, <span class="dt">criteria =</span> surname, <span class="dt">to_s4 =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Group criteria 1 - `surname`</span>
<span class="co">#&gt; 6 of 6 record(s) have been assigned a group ID. 0 record(s) not yet grouped.</span>
<span class="co">#&gt; 0 record(s) with unique group IDs untagged for possible matching in the next stage. The number of records not yet grouped is now 0.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Record grouping complete - 0 record(s) assigned a group unique ID.</span>

<span class="co"># 2 stage - Matching surname, then matching sex</span>
dbs<span class="op">$</span>pids_b &lt;-<span class="st"> </span><span class="kw">record_group</span>(dbs, <span class="dt">criteria =</span> <span class="kw">c</span>(surname, sex), <span class="dt">display =</span> <span class="ot">FALSE</span>, <span class="dt">to_s4 =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; Record grouping complete - 0 record(s) assigned a group unique ID.</span>

dbs
<span class="co">#&gt; # A tibble: 6 x 5</span>
<span class="co">#&gt;   forename surname sex   pids_a       pids_b      </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt; &lt;pid&gt;        &lt;pid&gt;       </span>
<span class="co">#&gt; 1 James    Green   M     P-1 (CRI 01) P-1 (CRI 01)</span>
<span class="co">#&gt; 2 ESTHER   Kulmar  F     P-2 (CRI 01) P-2 (CRI 01)</span>
<span class="co">#&gt; 3 &quot;&quot;       OBI     F     P-3 (CRI 01) P-3 (CRI 01)</span>
<span class="co">#&gt; 4 Jamey    Green   M     P-1 (CRI 01) P-1 (CRI 01)</span>
<span class="co">#&gt; 5 Daniel   Kulmar  M     P-2 (CRI 01) P-2 (CRI 01)</span>
<span class="co">#&gt; 6 Henry    OBI     M     P-3 (CRI 01) P-3 (CRI 01)</span>
<span class="co"># Note that exact matching is case sensitive. See range matching.</span></code></pre></div>
<p><a id="record_matching"></a></p>
<div id="record-matching" class="section level2">
<h2>Record matching</h2>
<p>The choice and ordering of column names in <code>criteria</code> and <code>sub_criteria</code> determines the relevance of matches at each stage. This flexibility allows you link records in different ways however, you should consider a practical combination which would yield more “true” matches than “false” matches.</p>
<p>For example, in <code>patient_list</code> above, linking on surnames and then sex (<code>pid_b</code>) leads to a different result compared to when linking on sex before surnames (<code>pid_c</code>). See <a href="#record_expansion">Record group expansion</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dbs<span class="op">$</span>pids_c &lt;-<span class="st"> </span><span class="kw">record_group</span>(dbs, <span class="dt">criteria =</span>  <span class="kw">c</span>(sex, surname), <span class="dt">display =</span> <span class="ot">FALSE</span>, <span class="dt">to_s4 =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; Record grouping complete - 0 record(s) assigned a group unique ID.</span>

dbs
<span class="co">#&gt; # A tibble: 6 x 6</span>
<span class="co">#&gt;   forename surname sex   pids_a       pids_b       pids_c      </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt; &lt;pid&gt;        &lt;pid&gt;        &lt;pid&gt;       </span>
<span class="co">#&gt; 1 James    Green   M     P-1 (CRI 01) P-1 (CRI 01) P-1 (CRI 01)</span>
<span class="co">#&gt; 2 ESTHER   Kulmar  F     P-2 (CRI 01) P-2 (CRI 01) P-2 (CRI 01)</span>
<span class="co">#&gt; 3 &quot;&quot;       OBI     F     P-3 (CRI 01) P-3 (CRI 01) P-2 (CRI 01)</span>
<span class="co">#&gt; 4 Jamey    Green   M     P-1 (CRI 01) P-1 (CRI 01) P-1 (CRI 01)</span>
<span class="co">#&gt; 5 Daniel   Kulmar  M     P-2 (CRI 01) P-2 (CRI 01) P-1 (CRI 01)</span>
<span class="co">#&gt; 6 Henry    OBI     M     P-3 (CRI 01) P-3 (CRI 01) P-1 (CRI 01)</span></code></pre></div>
<p>Both result are logically correct considering the <code>criteria</code> used however, a two stage linkage on surnames followed by sex is not the most practical option given the dataset. For instance, based on <code>pid_b</code>, records 3 and 6 have been linked together due to matching surnames, when they could actually be cousins not the same individual. A better combination would be forename at stage 1, followed by surname and sex at stage 2. See <code>pid_d</code> below;</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dbs_<span class="dv">2</span> &lt;-<span class="st"> </span>patient_list; dbs_<span class="dv">2</span>
<span class="co">#&gt; # A tibble: 6 x 4</span>
<span class="co">#&gt;   rd_id forename surname sex  </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;</span>
<span class="co">#&gt; 1     1 James    Green   M    </span>
<span class="co">#&gt; 2     2 ESTHER   Kulmar  F    </span>
<span class="co">#&gt; 3     3 &quot;&quot;       OBI     F    </span>
<span class="co">#&gt; 4     4 Jamey    Green   M    </span>
<span class="co">#&gt; 5     5 Daniel   Kulmar  M    </span>
<span class="co">#&gt; 6     6 Henry    OBI     M</span>

dbs_<span class="dv">2</span><span class="op">$</span>cri_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">paste</span>(dbs_<span class="dv">2</span><span class="op">$</span>surname, dbs_<span class="dv">2</span><span class="op">$</span>sex,<span class="dt">sep=</span><span class="st">&quot;-&quot;</span>)
dbs_<span class="dv">2</span><span class="op">$</span>pid_d &lt;-<span class="st"> </span><span class="kw">record_group</span>(dbs_<span class="dv">2</span>, rd_id, <span class="kw">c</span>(forename, cri_<span class="dv">2</span>), <span class="dt">display =</span> <span class="ot">FALSE</span>, <span class="dt">to_s4 =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; Record grouping complete - 4 record(s) assigned a group unique ID.</span>

dbs_<span class="dv">2</span>
<span class="co">#&gt; # A tibble: 6 x 6</span>
<span class="co">#&gt;   rd_id forename surname sex   cri_2    pid_d       </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;    &lt;pid&gt;       </span>
<span class="co">#&gt; 1     1 James    Green   M     Green-M  P-1 (CRI 02)</span>
<span class="co">#&gt; 2     2 ESTHER   Kulmar  F     Kulmar-F P-2 (No Hit)</span>
<span class="co">#&gt; 3     3 &quot;&quot;       OBI     F     OBI-F    P-3 (No Hit)</span>
<span class="co">#&gt; 4     4 Jamey    Green   M     Green-M  P-1 (CRI 02)</span>
<span class="co">#&gt; 5     5 Daniel   Kulmar  M     Kulmar-M P-5 (No Hit)</span>
<span class="co">#&gt; 6     6 Henry    OBI     M     OBI-M    P-6 (No Hit)</span></code></pre></div>
<p>As mentioned earlier, at each stage of record linkage, a <code>sub_criteria</code> can be used to include additional conditions for a match. Just like <code>criteria</code>, any column in the dataset can be used as a <code>sub_criteria</code>.</p>
<p><a id="sub_cri_example"></a></p>
<p>Below are examples of record linkage using different combinations of the same <code>criteria</code> and <code>sub_criteria</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyr)
<span class="kw">data</span>(Opes); Opes
<span class="co">#&gt; # A tibble: 8 x 8</span>
<span class="co">#&gt;   rd_id name  department  hair_colour date_of_birth db_pt1 db_pt2  db_pt3 </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt; &lt;chr&gt;       &lt;chr&gt;       &lt;chr&gt;         &lt;chr&gt;  &lt;chr&gt;   &lt;chr&gt;  </span>
<span class="co">#&gt; 1     1 Ope   Procurement Brown       23/03/1986    23/03  23/1986 03/1986</span>
<span class="co">#&gt; 2     2 Ope   Security    Brown       23/03/1986    23/03  23/1986 03/1986</span>
<span class="co">#&gt; 3     3 Ope   Security    Brown       23/03/1968    23/03  23/1968 03/1968</span>
<span class="co">#&gt; 4     4 Ope   Publishing  Green       01/02/1985    01/02  01/1985 02/1985</span>
<span class="co">#&gt; 5     5 Ope   Publishing  Teal        02/01/1985    02/01  02/1985 01/1985</span>
<span class="co">#&gt; 6     6 Ope   Publishing  Grey        11/03/1964    11/03  11/1964 03/1964</span>
<span class="co">#&gt; 7     7 Ope   Publishing  White       11/03/1964    11/03  11/1964 03/1964</span>
<span class="co">#&gt; 8     8 Ope   Procurement Black       11/10/1985    11/10  11/1985 10/1985</span>

<span class="co"># 1 stage linkage</span>
  <span class="co"># sub_criteria - name, and either department, hair colour or date of birth</span>
Opes<span class="op">$</span>pids_a &lt;-<span class="st"> </span><span class="kw">record_group</span>(Opes, <span class="dt">criteria =</span> name, 
                            <span class="dt">sub_criteria =</span> <span class="kw">list</span>(<span class="st">&quot;s1a&quot;</span>=<span class="kw">c</span>(<span class="st">&quot;department&quot;</span>,<span class="st">&quot;hair_colour&quot;</span>,<span class="st">&quot;date_of_birth&quot;</span>)),
                            <span class="dt">display =</span> <span class="ot">FALSE</span>, <span class="dt">to_s4 =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; Record grouping complete - 0 record(s) assigned a group unique ID.</span>

Opes[<span class="kw">c</span>(<span class="st">&quot;name&quot;</span>,<span class="st">&quot;department&quot;</span>,<span class="st">&quot;hair_colour&quot;</span>,<span class="st">&quot;date_of_birth&quot;</span>,<span class="st">&quot;pids_a&quot;</span>)]
<span class="co">#&gt; # A tibble: 8 x 5</span>
<span class="co">#&gt;   name  department  hair_colour date_of_birth pids_a      </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;       &lt;chr&gt;       &lt;chr&gt;         &lt;pid&gt;       </span>
<span class="co">#&gt; 1 Ope   Procurement Brown       23/03/1986    P-1 (CRI 01)</span>
<span class="co">#&gt; 2 Ope   Security    Brown       23/03/1986    P-1 (CRI 01)</span>
<span class="co">#&gt; 3 Ope   Security    Brown       23/03/1968    P-1 (CRI 01)</span>
<span class="co">#&gt; 4 Ope   Publishing  Green       01/02/1985    P-4 (CRI 01)</span>
<span class="co">#&gt; 5 Ope   Publishing  Teal        02/01/1985    P-4 (CRI 01)</span>
<span class="co">#&gt; 6 Ope   Publishing  Grey        11/03/1964    P-4 (CRI 01)</span>
<span class="co">#&gt; 7 Ope   Publishing  White       11/03/1964    P-4 (CRI 01)</span>
<span class="co">#&gt; 8 Ope   Procurement Black       11/10/1985    P-1 (CRI 01)</span>
  
<span class="co"># 1 stage linkage </span>
  <span class="co"># sub_criteria - name, and either department or hair colour, and date of birth </span>
Opes<span class="op">$</span>pids_b &lt;-<span class="st"> </span><span class="kw">record_group</span>(Opes, <span class="dt">criteria =</span> name, 
                            <span class="dt">sub_criteria =</span> <span class="kw">list</span>(
                              <span class="st">&quot;s1a&quot;</span>=<span class="kw">c</span>(<span class="st">&quot;department&quot;</span>,<span class="st">&quot;hair_colour&quot;</span>),
                              <span class="st">&quot;s1b&quot;</span>=<span class="kw">c</span>(<span class="st">&quot;date_of_birth&quot;</span>)),
                            <span class="dt">display =</span> <span class="ot">FALSE</span>, <span class="dt">to_s4 =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; Record grouping complete - 4 record(s) assigned a group unique ID.</span>

Opes[<span class="kw">c</span>(<span class="st">&quot;name&quot;</span>,<span class="st">&quot;department&quot;</span>,<span class="st">&quot;hair_colour&quot;</span>,<span class="st">&quot;date_of_birth&quot;</span>,<span class="st">&quot;pids_b&quot;</span>)]
<span class="co">#&gt; # A tibble: 8 x 5</span>
<span class="co">#&gt;   name  department  hair_colour date_of_birth pids_b      </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;       &lt;chr&gt;       &lt;chr&gt;         &lt;pid&gt;       </span>
<span class="co">#&gt; 1 Ope   Procurement Brown       23/03/1986    P-1 (CRI 01)</span>
<span class="co">#&gt; 2 Ope   Security    Brown       23/03/1986    P-1 (CRI 01)</span>
<span class="co">#&gt; 3 Ope   Security    Brown       23/03/1968    P-3 (No Hit)</span>
<span class="co">#&gt; 4 Ope   Publishing  Green       01/02/1985    P-4 (No Hit)</span>
<span class="co">#&gt; 5 Ope   Publishing  Teal        02/01/1985    P-5 (No Hit)</span>
<span class="co">#&gt; 6 Ope   Publishing  Grey        11/03/1964    P-6 (CRI 01)</span>
<span class="co">#&gt; 7 Ope   Publishing  White       11/03/1964    P-6 (CRI 01)</span>
<span class="co">#&gt; 8 Ope   Procurement Black       11/10/1985    P-8 (No Hit)</span>

<span class="co"># 1 stage linkage </span>
  <span class="co"># sub_criteria - name, and either department or hair colour, and either day and month of birth, day and year of birth or month and year of birth</span>
Opes<span class="op">$</span>pids_c &lt;-<span class="st"> </span><span class="kw">record_group</span>(Opes, <span class="dt">criteria =</span> name, 
                            <span class="dt">sub_criteria =</span> <span class="kw">list</span>(
                              <span class="st">&quot;s1a&quot;</span>=<span class="kw">c</span>(<span class="st">&quot;department&quot;</span>,<span class="st">&quot;hair_colour&quot;</span>), 
                              <span class="st">&quot;s1b&quot;</span>=<span class="kw">c</span>(<span class="st">&quot;db_pt1&quot;</span>,<span class="st">&quot;db_pt2&quot;</span>,<span class="st">&quot;db_pt3&quot;</span>)),
                            <span class="dt">display =</span> <span class="ot">FALSE</span>, <span class="dt">to_s4 =</span><span class="ot">TRUE</span>)
<span class="co">#&gt; Record grouping complete - 3 record(s) assigned a group unique ID.</span>

Opes[<span class="kw">c</span>(<span class="st">&quot;name&quot;</span>,<span class="st">&quot;department&quot;</span>,<span class="st">&quot;hair_colour&quot;</span>,<span class="st">&quot;date_of_birth&quot;</span>,<span class="st">&quot;pids_c&quot;</span>)]
<span class="co">#&gt; # A tibble: 8 x 5</span>
<span class="co">#&gt;   name  department  hair_colour date_of_birth pids_c      </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;       &lt;chr&gt;       &lt;chr&gt;         &lt;pid&gt;       </span>
<span class="co">#&gt; 1 Ope   Procurement Brown       23/03/1986    P-1 (CRI 01)</span>
<span class="co">#&gt; 2 Ope   Security    Brown       23/03/1986    P-1 (CRI 01)</span>
<span class="co">#&gt; 3 Ope   Security    Brown       23/03/1968    P-1 (CRI 01)</span>
<span class="co">#&gt; 4 Ope   Publishing  Green       01/02/1985    P-4 (No Hit)</span>
<span class="co">#&gt; 5 Ope   Publishing  Teal        02/01/1985    P-5 (No Hit)</span>
<span class="co">#&gt; 6 Ope   Publishing  Grey        11/03/1964    P-6 (CRI 01)</span>
<span class="co">#&gt; 7 Ope   Publishing  White       11/03/1964    P-6 (CRI 01)</span>
<span class="co">#&gt; 8 Ope   Procurement Black       11/10/1985    P-8 (No Hit)</span>

<span class="co"># 1 stage linkage </span>
  <span class="co"># sub_criteria - name, and department, and hair colour, and either day and month of birth, day and year of birth or month and year of birth</span>
Opes<span class="op">$</span>pids_d &lt;-<span class="st"> </span><span class="kw">record_group</span>(Opes, <span class="dt">criteria =</span>name, 
               <span class="dt">sub_criteria =</span> <span class="kw">list</span>(
                 <span class="st">&quot;s1a&quot;</span>=<span class="kw">c</span>(<span class="st">&quot;department&quot;</span>),
                 <span class="st">&quot;s1c&quot;</span>=<span class="kw">c</span>(<span class="st">&quot;hair_colour&quot;</span>),
                 <span class="st">&quot;s1b&quot;</span>=<span class="kw">c</span>(<span class="st">&quot;db_pt1&quot;</span>,<span class="st">&quot;db_pt2&quot;</span>,<span class="st">&quot;db_pt3&quot;</span>)),  
               <span class="dt">display =</span> <span class="ot">FALSE</span>, <span class="dt">to_s4 =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; Record grouping complete - 6 record(s) assigned a group unique ID.</span>

Opes[<span class="kw">c</span>(<span class="st">&quot;name&quot;</span>,<span class="st">&quot;department&quot;</span>,<span class="st">&quot;hair_colour&quot;</span>,<span class="st">&quot;date_of_birth&quot;</span>,<span class="st">&quot;pids_d&quot;</span>)]
<span class="co">#&gt; # A tibble: 8 x 5</span>
<span class="co">#&gt;   name  department  hair_colour date_of_birth pids_d      </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;       &lt;chr&gt;       &lt;chr&gt;         &lt;pid&gt;       </span>
<span class="co">#&gt; 1 Ope   Procurement Brown       23/03/1986    P-1 (No Hit)</span>
<span class="co">#&gt; 2 Ope   Security    Brown       23/03/1986    P-2 (CRI 01)</span>
<span class="co">#&gt; 3 Ope   Security    Brown       23/03/1968    P-2 (CRI 01)</span>
<span class="co">#&gt; 4 Ope   Publishing  Green       01/02/1985    P-4 (No Hit)</span>
<span class="co">#&gt; 5 Ope   Publishing  Teal        02/01/1985    P-5 (No Hit)</span>
<span class="co">#&gt; 6 Ope   Publishing  Grey        11/03/1964    P-6 (No Hit)</span>
<span class="co">#&gt; 7 Ope   Publishing  White       11/03/1964    P-7 (No Hit)</span>
<span class="co">#&gt; 8 Ope   Procurement Black       11/10/1985    P-8 (No Hit)</span></code></pre></div>
<p>Note that using <code>sub_criteria</code> costs additional processing time, so it should be avoided when unnecessary. For example, the two implementations below (<code>pids_e</code> and <code>pids_f</code>) will yield the same result. However, the second one will take less time to complete. This time difference is more noticeable with very large datasets.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 1 stage linkage </span>
  <span class="co"># stage 1 - name, and date of birth, and department and hair colour </span>
Opes<span class="op">$</span>pids_e &lt;-<span class="st"> </span><span class="kw">record_group</span>(Opes, <span class="dt">criteri =</span> name, 
                            <span class="dt">sub_criteria =</span> <span class="kw">list</span>(
                              <span class="st">&quot;s1a&quot;</span>=<span class="kw">c</span>(<span class="st">&quot;department&quot;</span>), 
                              <span class="st">&quot;s1b&quot;</span>=<span class="kw">c</span>(<span class="st">&quot;hair_colour&quot;</span>), 
                              <span class="st">&quot;s1c&quot;</span>=<span class="kw">c</span>(<span class="st">&quot;date_of_birth&quot;</span>)),
                            <span class="dt">display =</span> <span class="ot">TRUE</span>, <span class="dt">to_s4 =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Group criteria 1 - `name`</span>
<span class="co">#&gt; Matching criteria 1: iteration 2</span>
<span class="co">#&gt; Matching criteria 1: iteration 3</span>
<span class="co">#&gt; Matching criteria 1: iteration 4</span>
<span class="co">#&gt; Matching criteria 1: iteration 5</span>
<span class="co">#&gt; Matching criteria 1: iteration 6</span>
<span class="co">#&gt; Matching criteria 1: iteration 7</span>
<span class="co">#&gt; Matching criteria 1: iteration 8</span>
<span class="co">#&gt; 8 of 8 record(s) have been assigned a group ID. 0 record(s) not yet grouped.</span>
<span class="co">#&gt; 8 record(s) with unique group IDs untagged for possible matching in the next stage. The number of records not yet grouped is now 8.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Record grouping complete - 8 record(s) assigned a group unique ID.</span>

Opes<span class="op">$</span>cri &lt;-<span class="st"> </span><span class="kw">paste</span>(Opes<span class="op">$</span>name, Opes<span class="op">$</span>date_of_birth, Opes<span class="op">$</span>department, Opes<span class="op">$</span>hair_colour, <span class="dt">sep=</span><span class="st">&quot;-&quot;</span>)

Opes<span class="op">$</span>pids_f &lt;-<span class="st"> </span><span class="kw">record_group</span>(Opes, <span class="dt">criteria =</span> cri,  <span class="dt">display =</span> <span class="ot">TRUE</span>, <span class="dt">to_s4 =</span><span class="ot">TRUE</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Group criteria 1 - `cri`</span>
<span class="co">#&gt; 8 of 8 record(s) have been assigned a group ID. 0 record(s) not yet grouped.</span>
<span class="co">#&gt; 8 record(s) with unique group IDs untagged for possible matching in the next stage. The number of records not yet grouped is now 8.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Record grouping complete - 8 record(s) assigned a group unique ID.</span>

Opes[<span class="kw">c</span>(<span class="st">&quot;name&quot;</span>,<span class="st">&quot;department&quot;</span>,<span class="st">&quot;hair_colour&quot;</span>,<span class="st">&quot;date_of_birth&quot;</span>,<span class="st">&quot;pids_e&quot;</span>,<span class="st">&quot;pids_f&quot;</span>)]
<span class="co">#&gt; # A tibble: 8 x 6</span>
<span class="co">#&gt;   name  department  hair_colour date_of_birth pids_e       pids_f      </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;       &lt;chr&gt;       &lt;chr&gt;         &lt;pid&gt;        &lt;pid&gt;       </span>
<span class="co">#&gt; 1 Ope   Procurement Brown       23/03/1986    P-1 (No Hit) P-1 (No Hit)</span>
<span class="co">#&gt; 2 Ope   Security    Brown       23/03/1986    P-2 (No Hit) P-2 (No Hit)</span>
<span class="co">#&gt; 3 Ope   Security    Brown       23/03/1968    P-3 (No Hit) P-3 (No Hit)</span>
<span class="co">#&gt; 4 Ope   Publishing  Green       01/02/1985    P-4 (No Hit) P-4 (No Hit)</span>
<span class="co">#&gt; 5 Ope   Publishing  Teal        02/01/1985    P-5 (No Hit) P-5 (No Hit)</span>
<span class="co">#&gt; 6 Ope   Publishing  Grey        11/03/1964    P-6 (No Hit) P-6 (No Hit)</span>
<span class="co">#&gt; 7 Ope   Publishing  White       11/03/1964    P-7 (No Hit) P-7 (No Hit)</span>
<span class="co">#&gt; 8 Ope   Procurement Black       11/10/1985    P-8 (No Hit) P-8 (No Hit)</span></code></pre></div>
<div id="range-matching" class="section level3">
<h3>Range matching</h3>
<p>Records can be matched in two ways; exact matches as in the examples above, or matching a range of values. The latter is done by converting the range of values to a <code>number_line()</code> object, and the <code>gid</code> argument/slot set to the actual value. This <code>number_line</code> object is then used as a <code>sub_criteria</code>. <code>number_line</code> objects are considered a match if they overlap. See the example below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lubridate)
Opes_c &lt;-<span class="st"> </span>Opes[<span class="st">&quot;date_of_birth&quot;</span>]
Opes_c
<span class="co">#&gt; # A tibble: 8 x 1</span>
<span class="co">#&gt;   date_of_birth</span>
<span class="co">#&gt;   &lt;chr&gt;        </span>
<span class="co">#&gt; 1 23/03/1986   </span>
<span class="co">#&gt; 2 23/03/1986   </span>
<span class="co">#&gt; 3 23/03/1968   </span>
<span class="co">#&gt; 4 01/02/1985   </span>
<span class="co">#&gt; 5 02/01/1985   </span>
<span class="co">#&gt; 6 11/03/1964   </span>
<span class="co">#&gt; 7 11/03/1964   </span>
<span class="co">#&gt; 8 11/10/1985</span>

<span class="co"># Match on date of birth + 3 months</span>
Opes_c<span class="op">$</span>date_of_birth &lt;-<span class="st"> </span><span class="kw">dmy</span>(Opes_c<span class="op">$</span>date_of_birth)
Opes_c<span class="op">$</span>range_a &lt;-<span class="st"> </span><span class="kw">expand_number_line</span>(<span class="kw">as.number_line</span>(Opes_c<span class="op">$</span>date_of_birth), <span class="kw">period</span>(<span class="dv">2</span>, <span class="st">&quot;years&quot;</span>), <span class="st">&quot;end&quot;</span>)
Opes_c<span class="op">$</span>range_a<span class="op">@</span>gid &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(Opes_c<span class="op">$</span>date_of_birth)

Opes_c<span class="op">$</span>pids_a &lt;-<span class="st"> </span><span class="kw">record_group</span>(Opes_c, <span class="dt">criteria =</span> range_a, <span class="dt">to_s4 =</span><span class="ot">TRUE</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Group criteria 1 - `dmvr_d1`</span>
<span class="co">#&gt; Matching criteria 1: iteration 2</span>
<span class="co">#&gt; Matching criteria 1: iteration 3</span>
<span class="co">#&gt; Matching criteria 1: iteration 4</span>
<span class="co">#&gt; Matching criteria 1: iteration 5</span>
<span class="co">#&gt; Matching criteria 1: iteration 6</span>
<span class="co">#&gt; Matching criteria 1: iteration 7</span>
<span class="co">#&gt; Matching criteria 1: iteration 8</span>
<span class="co">#&gt; Matching criteria 1: iteration 9</span>
<span class="co">#&gt; 8 of 8 record(s) have been assigned a group ID. 0 record(s) not yet grouped.</span>
<span class="co">#&gt; 2 record(s) with unique group IDs untagged for possible matching in the next stage. The number of records not yet grouped is now 2.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Record grouping complete - 2 record(s) assigned a group unique ID.</span>

Opes_c[<span class="kw">c</span>(<span class="st">&quot;date_of_birth&quot;</span>,<span class="st">&quot;range_a&quot;</span>,<span class="st">&quot;pids_a&quot;</span>)]
<span class="co">#&gt; # A tibble: 8 x 3</span>
<span class="co">#&gt;   date_of_birth range_a                  pids_a      </span>
<span class="co">#&gt;   &lt;date&gt;        &lt;numbr_ln&gt;               &lt;pid&gt;       </span>
<span class="co">#&gt; 1 1986-03-23    1986-03-23 -&gt; 1988-03-23 P-4 (CRI 01)</span>
<span class="co">#&gt; 2 1986-03-23    1986-03-23 -&gt; 1988-03-23 P-4 (CRI 01)</span>
<span class="co">#&gt; 3 1968-03-23    1968-03-23 -&gt; 1970-03-23 P-3 (No Hit)</span>
<span class="co">#&gt; 4 1985-02-01    1985-02-01 -&gt; 1987-02-01 P-4 (CRI 01)</span>
<span class="co">#&gt; 5 1985-01-02    1985-01-02 -&gt; 1987-01-02 P-5 (No Hit)</span>
<span class="co">#&gt; 6 1964-03-11    1964-03-11 -&gt; 1966-03-11 P-6 (CRI 01)</span>
<span class="co">#&gt; 7 1964-03-11    1964-03-11 -&gt; 1966-03-11 P-6 (CRI 01)</span>
<span class="co">#&gt; 8 1985-10-11    1985-10-11 -&gt; 1987-10-11 P-4 (CRI 01)</span>

<span class="co"># Match on age +/- 5 years</span>
Opes_c<span class="op">$</span>age &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">round</span>((<span class="kw">Sys.Date</span>() <span class="op">-</span><span class="st"> </span>Opes_c<span class="op">$</span>date_of_birth)<span class="op">/</span><span class="fl">365.5</span>)) <span class="co"># approximate age</span>
Opes_c<span class="op">$</span>range_b &lt;-<span class="st"> </span><span class="kw">expand_number_line</span>(<span class="kw">as.number_line</span>(Opes_c<span class="op">$</span>age), <span class="dv">5</span>, <span class="st">&quot;both&quot;</span>)
Opes_c<span class="op">$</span>range_b<span class="op">@</span>gid &lt;-<span class="st"> </span>Opes_c<span class="op">$</span>age

Opes_c<span class="op">$</span>pids_b &lt;-<span class="st"> </span><span class="kw">record_group</span>(Opes_c, <span class="dt">criteria =</span> range_b, <span class="dt">to_s4 =</span><span class="ot">TRUE</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Group criteria 1 - `dmvr_d1`</span>
<span class="co">#&gt; Matching criteria 1: iteration 2</span>
<span class="co">#&gt; 8 of 8 record(s) have been assigned a group ID. 0 record(s) not yet grouped.</span>
<span class="co">#&gt; 0 record(s) with unique group IDs untagged for possible matching in the next stage. The number of records not yet grouped is now 0.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Record grouping complete - 0 record(s) assigned a group unique ID.</span>

Opes_c[<span class="kw">c</span>(<span class="st">&quot;age&quot;</span>,<span class="st">&quot;range_b&quot;</span>,<span class="st">&quot;pids_b&quot;</span>)]
<span class="co">#&gt; # A tibble: 8 x 3</span>
<span class="co">#&gt;     age range_b    pids_b      </span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;numbr_ln&gt; &lt;pid&gt;       </span>
<span class="co">#&gt; 1    34 29 -&gt; 39   P-1 (CRI 01)</span>
<span class="co">#&gt; 2    34 29 -&gt; 39   P-1 (CRI 01)</span>
<span class="co">#&gt; 3    52 47 -&gt; 57   P-3 (CRI 01)</span>
<span class="co">#&gt; 4    35 30 -&gt; 40   P-1 (CRI 01)</span>
<span class="co">#&gt; 5    35 30 -&gt; 40   P-1 (CRI 01)</span>
<span class="co">#&gt; 6    56 51 -&gt; 61   P-3 (CRI 01)</span>
<span class="co">#&gt; 7    56 51 -&gt; 61   P-3 (CRI 01)</span>
<span class="co">#&gt; 8    34 29 -&gt; 39   P-1 (CRI 01)</span></code></pre></div>
<p><a id="record_expansion"></a></p>
</div>
</div>
<div id="record-group-expansion" class="section level2">
<h2>Record group expansion</h2>
<p>At each stage of record linkage, records are either assigned a new group ID or inherit an existing one. The following scenario explain how these happen;</p>
<ul>
<li>If a record only matches others that have not yet been assigned a group ID, it and the others will then be assigned a new group ID</li>
<li>If a record matches others which already have a group ID, the record will inherit the existing group ID. Note that if it matches multiple records with existing but different group IDs, the ID assigned at the earliest stage is the one inherited</li>
<li>If a record does not match any other record, it will not be assigned a group ID. If by the last stage, it still has not matched any other record, it is assigned a unique group ID</li>
</ul>
<p>It’s worth reiterating that <code>record_group()</code> expects the <code>criteria</code> to be listed in order of decreasing relevance. Therefore, existing group IDs can be inherited but will not be overwritten. This is because groups formed at earlier stages are considered more “certain” than those formed at subsequent stages.</p>
<p>The example below with <code>patient_list</code> demonstrates this behaviour.</p>
<ul>
<li>Stage 1 - Only records 3 and 4 are grouped together and therefore assigned a new group ID (<code>3</code>). Records 1 and 2 are excluded from grouping at this stage because of <a href="#missing_values">missing values</a>. Record 5 is not assigned a group ID because it doesn’t match any other record.</li>
<li>Stage 2 - Records 1 and 2 are grouped together based on matching surnames and assigned a new group ID (<code>1</code>). Records 3 and 4 do not match on surnames but remain grouped together since they’ve previously been matched on forenames, which is more “certain” as listed in <code>criteria</code>. Record 5 is still not assigned a group ID since it doesn’t match any other record on surnames.</li>
<li>Stage 3 - Record 5 matches record 1 and 3 which belong to different group IDs. However, it will inherit record 3’s group ID (<code>3</code>) because that was assigned at stage 1 (<code>&quot;Criteria 1&quot;</code>) as opposed to record 2’s group ID which was assigned at stage 2 (<code>&quot;Criteria 2&quot;</code>).</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(patient_list_<span class="dv">2</span>); patient_list_<span class="dv">2</span>
<span class="co">#&gt; # A tibble: 5 x 4</span>
<span class="co">#&gt;   rd_id forename surname     sex   </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt; </span>
<span class="co">#&gt; 1     1 &quot;&quot;       Jefferson   Male  </span>
<span class="co">#&gt; 2     2 &quot;&quot;       Jefferson   Female</span>
<span class="co">#&gt; 3     3 Tomi     Abdul       Male  </span>
<span class="co">#&gt; 4     4 Tomi     Abdulkareem Female</span>
<span class="co">#&gt; 5     5 &lt;NA&gt;     &lt;NA&gt;        Male</span>

patient_list_<span class="dv">2</span><span class="op">$</span>pids_a &lt;-<span class="st"> </span><span class="kw">record_group</span>(patient_list_<span class="dv">2</span>, rd_id, <span class="kw">c</span>(forename, surname, sex), <span class="dt">to_s4 =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Group criteria 1 - `forename`</span>
<span class="co">#&gt; 2 of 5 record(s) have been assigned a group ID. 3 record(s) not yet grouped.</span>
<span class="co">#&gt; 0 record(s) with unique group IDs untagged for possible matching in the next stage. The number of records not yet grouped is now 3.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Group criteria 2 - `surname`</span>
<span class="co">#&gt; 2 of 3 record(s) have been assigned a group ID. 1 record(s) not yet grouped.</span>
<span class="co">#&gt; 0 record(s) with unique group IDs untagged for possible matching in the next stage. The number of records not yet grouped is now 1.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Group criteria 3 - `sex`</span>
<span class="co">#&gt; 1 of 1 record(s) have been assigned a group ID. 0 record(s) not yet grouped.</span>
<span class="co">#&gt; 0 record(s) with unique group IDs untagged for possible matching in the next stage. The number of records not yet grouped is now 0.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Record grouping complete - 0 record(s) assigned a group unique ID.</span>

patient_list_<span class="dv">2</span>
<span class="co">#&gt; # A tibble: 5 x 5</span>
<span class="co">#&gt;   rd_id forename surname     sex    pids_a      </span>
<span class="co">#&gt;   &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;  &lt;pid&gt;       </span>
<span class="co">#&gt; 1     1 &quot;&quot;       Jefferson   Male   P-1 (CRI 02)</span>
<span class="co">#&gt; 2     2 &quot;&quot;       Jefferson   Female P-1 (CRI 02)</span>
<span class="co">#&gt; 3     3 Tomi     Abdul       Male   P-3 (CRI 01)</span>
<span class="co">#&gt; 4     4 Tomi     Abdulkareem Female P-3 (CRI 01)</span>
<span class="co">#&gt; 5     5 &lt;NA&gt;     &lt;NA&gt;        Male   P-3 (CRI 03)</span></code></pre></div>
<p><a id="missing_values"></a></p>
</div>
<div id="handling-missing-values" class="section level2">
<h2>Handling missing values</h2>
<p>Records with missing values for a particular <code>criteria</code> are excluded from that stage of record linkage. If a record has missing values for every listed <code>criteria</code>, it’s assigned a unique group ID at the end of record linkage.</p>
<p>It’s common for databases to use specific characters or numbers to represent missing or unknown data e.g. <code>N/A</code>, <code>Nil</code>, <code>01/01/1100</code>, <code>111111</code> etc. These pseudo-missing values will need to be recoded to one of the two recognised by <code>record_group()</code> - <code>NA</code> or an empty string (<code>&quot;&quot;</code>). If this is not done, the function will assume the pseudo-missing values are valid values and therefore group them together. This can cause a continuous cascade of false matches as seen below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">patient_list_<span class="dv">2</span><span class="op">$</span>forename &lt;-<span class="st"> </span><span class="kw">ifelse</span>(patient_list_<span class="dv">2</span><span class="op">$</span>rd_id <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="st">&quot;Nil&quot;</span>, patient_list_<span class="dv">2</span><span class="op">$</span>forename)
<span class="co"># 2 stage linkage</span>
    <span class="co"># Stage 1 - forename</span>
    <span class="co"># Stage 2 - Surname</span>
patient_list_<span class="dv">2</span><span class="op">$</span>pids_b &lt;-<span class="st"> </span><span class="kw">record_group</span>(patient_list_<span class="dv">2</span>, <span class="dt">criteria =</span> <span class="kw">c</span>(forename, surname), 
                                      <span class="dt">display =</span> <span class="ot">FALSE</span>, <span class="dt">to_s4 =</span><span class="ot">TRUE</span>)
<span class="co">#&gt; Record grouping complete - 2 record(s) assigned a group unique ID.</span>

<span class="co"># 2 stage linkage</span>
    <span class="co"># Stage 1 - forename</span>
    <span class="co"># Stage 2 - Surname and sex</span>
patient_list_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">mutate</span>(patient_list_<span class="dv">2</span>, <span class="dt">cri_3 =</span> <span class="kw">paste</span>(surname,sex,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>))

patient_list_<span class="dv">2</span><span class="op">$</span>pids_c &lt;-<span class="st"> </span><span class="kw">record_group</span>(patient_list_<span class="dv">2</span>, <span class="dt">criteria =</span> <span class="kw">c</span>(forename, cri_<span class="dv">3</span>), 
                                      <span class="dt">display =</span> <span class="ot">FALSE</span>, <span class="dt">to_s4 =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; Record grouping complete - 2 record(s) assigned a group unique ID.</span>

patient_list_<span class="dv">2</span>[<span class="kw">c</span>(<span class="st">&quot;forename&quot;</span>,<span class="st">&quot;surname&quot;</span>,<span class="st">&quot;sex&quot;</span>,<span class="st">&quot;pids_b&quot;</span>,<span class="st">&quot;pids_c&quot;</span>)]
<span class="co">#&gt; # A tibble: 5 x 5</span>
<span class="co">#&gt;   forename surname     sex    pids_b       pids_c      </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;  &lt;pid&gt;        &lt;pid&gt;       </span>
<span class="co">#&gt; 1 Nil      Jefferson   Male   P-1 (CRI 01) P-1 (CRI 01)</span>
<span class="co">#&gt; 2 Nil      Jefferson   Female P-1 (CRI 01) P-1 (CRI 01)</span>
<span class="co">#&gt; 3 Nil      Abdul       Male   P-1 (CRI 01) P-1 (CRI 01)</span>
<span class="co">#&gt; 4 Tomi     Abdulkareem Female P-4 (No Hit) P-4 (No Hit)</span>
<span class="co">#&gt; 5 &lt;NA&gt;     &lt;NA&gt;        Male   P-5 (No Hit) P-5 (No Hit)</span></code></pre></div>
<p>In the example above, records 1-3 are assigned a single group ID based on matching forenames (<code>&quot;Nil&quot;</code>). Then records 4-6 are assigned the same group ID because they having matching surnames with either records 1-3. Even when stage 2 is changed to matching surnames and sex, records 2 and 3 are still “incorrectly” grouped together. Although, this is likely not the desired outcome, it’s the expected result given the parameters supplied to the function. This issue can be addressed by recoding <code>&quot;Nil&quot;</code> to <code>NA</code> or <code>&quot;&quot;</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Using NA as the proxy for missing value</span>
patient_list_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">mutate</span>(patient_list_<span class="dv">2</span>,<span class="dt">forename =</span> <span class="kw">ifelse</span>(forename<span class="op">==</span><span class="st">&quot;Nil&quot;</span>,<span class="ot">NA</span>,forename))

patient_list_<span class="dv">2</span><span class="op">$</span>pids_d &lt;-<span class="st"> </span><span class="kw">record_group</span>(patient_list_<span class="dv">2</span>, rd_id, <span class="kw">c</span>(forename, surname), 
                                      <span class="dt">display =</span> <span class="ot">FALSE</span>, <span class="dt">to_s4 =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; Record grouping complete - 3 record(s) assigned a group unique ID.</span>

<span class="co"># Using &quot;&quot; as the proxy for missing value</span>
patient_list_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw">mutate</span>(patient_list_<span class="dv">2</span>,<span class="dt">forename =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(forename),<span class="st">&quot;&quot;</span>,forename))  

patient_list_<span class="dv">2</span><span class="op">$</span>pids_e &lt;-<span class="st"> </span><span class="kw">record_group</span>(patient_list_<span class="dv">2</span>, rd_id, <span class="kw">c</span>(forename, surname), 
                                      <span class="dt">display =</span> <span class="ot">FALSE</span>, <span class="dt">to_s4 =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; Record grouping complete - 3 record(s) assigned a group unique ID.</span>

patient_list_<span class="dv">2</span>[<span class="kw">c</span>(<span class="st">&quot;forename&quot;</span>,<span class="st">&quot;surname&quot;</span>,<span class="st">&quot;sex&quot;</span>,<span class="st">&quot;pids_d&quot;</span>,<span class="st">&quot;pids_e&quot;</span>)]
<span class="co">#&gt; # A tibble: 5 x 5</span>
<span class="co">#&gt;   forename surname     sex    pids_d       pids_e      </span>
<span class="co">#&gt;   &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;  &lt;pid&gt;        &lt;pid&gt;       </span>
<span class="co">#&gt; 1 &quot;&quot;       Jefferson   Male   P-1 (CRI 02) P-1 (CRI 02)</span>
<span class="co">#&gt; 2 &quot;&quot;       Jefferson   Female P-1 (CRI 02) P-1 (CRI 02)</span>
<span class="co">#&gt; 3 &quot;&quot;       Abdul       Male   P-3 (No Hit) P-3 (No Hit)</span>
<span class="co">#&gt; 4 Tomi     Abdulkareem Female P-4 (No Hit) P-4 (No Hit)</span>
<span class="co">#&gt; 5 &quot;&quot;       &lt;NA&gt;        Male   P-5 (No Hit) P-5 (No Hit)</span></code></pre></div>
</div>
</div>
<div id="conclusion" class="section level1">
<h1>Conclusion</h1>
<p>As a general rule, the more unique a criteria, the earlier it should be listed in <code>criteria</code>. Also, the set and ordering of <code>criteria</code> is a personal choice but should also be practical given the dataset. For example, when linking a vehicular database with no existing identifier, vehicle colour alone is less practical than colour and brand name, which in turn is less practical than colour, brand name, make and model. However colour, brand name, make and model and 10 other parameters might be too strict and would need to be relaxed. On the other hand, the dataset could be so small that vehicle colour alone is a sufficient <code>criteria</code>. <code>record_group()</code> aims to minimize false mismatches due to random errors in data collection or missing values. The choice and ordering of <code>criteria</code> and <code>sub_criteria</code> should balance the availability of alternative identifiers with their practicality as group identifiers.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
